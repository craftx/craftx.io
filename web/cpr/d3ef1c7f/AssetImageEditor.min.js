Craft.AssetImageEditor=Garnish.Modal.extend({$body:null,$footer:null,$imageTools:null,$buttons:null,$cancelBtn:null,$replaceBtn:null,$saveBtn:null,$editorContainer:null,$straighten:null,$croppingCanvas:null,canvas:null,image:null,viewport:null,focalPoint:null,grid:null,croppingCanvas:null,clipper:null,croppingRectangle:null,cropperHandles:null,cropperGrid:null,croppingShade:null,imageStraightenAngle:0,viewportRotation:0,originalWidth:0,originalHeight:0,imageVerticeCoords:null,zoomRatio:1,animationInProgress:!1,currentView:"rotate",assetId:null,cacheBust:null,draggingCropper:!1,scalingCropper:!1,draggingFocal:!1,previousMouseX:0,previousMouseY:0,shiftKeyHeld:!1,editorHeight:0,editorWidth:0,cropperState:!1,scaleFactor:1,flipData:{},focalPointState:!1,renderImage:null,renderCropper:null,init:function(a,b){this.cacheBust=Date.now(),this.setSettings(b,Craft.AssetImageEditor.defaults),this.assetId=a,this.flipData={x:0,y:0},this.$container=$('<form class="modal fitted imageeditor"></form>').appendTo(Garnish.$bod),this.$body=$('<div class="body"></div>').appendTo(this.$container),this.$footer=$('<div class="footer"/>').appendTo(this.$container),this.base(this.$container,this.settings),this.$buttons=$('<div class="buttons right"/>').appendTo(this.$footer),this.$cancelBtn=$('<div class="btn cancel">'+Craft.t("app","Cancel")+"</div>").appendTo(this.$buttons),this.$replaceBtn=$('<div class="btn submit save replace">'+Craft.t("app","Replace Asset")+"</div>").appendTo(this.$buttons),this.settings.allowSavingAsNew&&(this.$saveBtn=$('<div class="btn submit save copy">'+Craft.t("app","Save as New Asset")+"</div>").appendTo(this.$buttons),this.addListener(this.$saveBtn,"activate",this.saveImage.bind(this))),this.addListener(this.$replaceBtn,"activate",this.saveImage.bind(this)),this.addListener(this.$cancelBtn,"activate",$.proxy(this,"hide")),this.removeListener(this.$shade,"click"),this.setMaxImageSize(),Craft.postActionRequest("assets/image-editor",{assetId:a},$.proxy(this,"loadEditor"))},setMaxImageSize:function(){var a=Garnish.$doc.get(0).documentElement.clientWidth,b=Garnish.$doc.get(0).documentElement.clientHeight;this.maxImageSize=Math.max(b,a)},loadEditor:function(a){a.html||alert(Craft.t("Could not load the Asset image editor.","app")),this.$body.html(a.html),this.$tabs=$(".tabs li",this.$body),this.$viewsContainer=$(".views",this.$body),this.$views=$("> div",this.$viewsContainer),this.$imageTools=$(".image-container .image-tools",this.$body),this.$editorContainer=$(".image-container .image",this.$body),this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this.updateSizeAndPosition(),this.canvas=new fabric.StaticCanvas("image-canvas"),this.$croppingCanvas=$("#cropping-canvas",this.$editorContainer),this.$croppingCanvas.width(this.editorWidth),this.$croppingCanvas.height(this.editorHeight),this.canvas.enableRetinaScaling=!0,this.renderImage=function(){Garnish.requestAnimationFrame(this.canvas.renderAll.bind(this.canvas))}.bind(this);var b=Craft.getActionUrl("assets/edit-image",{assetId:this.assetId,size:this.maxImageSize,cacheBust:this.cacheBust});fabric.Image.fromURL(b,$.proxy(function(b){this.image=b,this.image.set({originX:"center",originY:"center",left:this.editorWidth/2,top:this.editorHeight/2}),this.canvas.add(this.image),this.originalHeight=this.image.getHeight(),this.originalWidth=this.image.getWidth(),this.zoomRatio=1,this._setFittedImageVerticeCoordinates(),this._repositionEditorElements();var c={imageDimensions:this.getScaledImageDimensions(),offsetX:0,offsetY:0},d=!1;if(a.focalPoint){var e=a.focalPoint,f=c.imageDimensions.width*e.x,g=c.imageDimensions.height*e.y;c.offsetX=f-c.imageDimensions.width/2,c.offsetY=g-c.imageDimensions.height/2,d=!0}this.storeFocalPointState(c),d&&this._createFocalPoint(),this._createViewport(),this.storeCropperState(),this._addControlListeners(),this.addListener(this.$croppingCanvas,"mousemove",this._handleMouseMove.bind(this)),this.addListener(this.$croppingCanvas,"mousedown",this._handleMouseDown.bind(this)),this.addListener(this.$croppingCanvas,"mouseup",this._handleMouseUp.bind(this)),this.addListener(this.$croppingCanvas,"mouseout",function(a){this._handleMouseUp(a),this._handleMouseMove(a)}.bind(this)),this.renderImage(),this.$tabs.first().trigger("click")},this))},updateSizeAndPosition:function(){if(this.$container){var a=window.innerWidth,b=window.innerHeight;this.$container.css({width:a,"min-width":a,left:0,height:b,"min-height":b,top:0}),this.$body.css({height:b-58}),a<b?this.$container.addClass("vertical"):this.$container.removeClass("vertical"),this.$editorContainer&&this.image&&this._repositionEditorElements()}},_repositionEditorElements:function(){var a={width:this.editorWidth,height:this.editorHeight};if(this.editorHeight=this.$editorContainer.innerHeight(),this.editorWidth=this.$editorContainer.innerWidth(),this.canvas.setDimensions({width:this.editorWidth,height:this.editorHeight}),"crop"==this.currentView){this.zoomRatio=this.getZoomToFitRatio(this.getScaledImageDimensions());var b=this._getBoundingRectangle(this.imageVerticeCoords);this._setFittedImageVerticeCoordinates(),this._repositionCropper(b)}else this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor;this._repositionImage(a),this._repositionViewport(),this._repositionFocalPoint(a),this._zoomImage(),this.renderImage()},_repositionImage:function(a){this.image.set({left:this.image.left-(a.width-this.editorWidth)/2,top:this.image.top-(a.height-this.editorHeight)/2})},_createViewport:function(){this.viewport=new fabric.Rect({width:this.image.width,height:this.image.height,fill:"rgba(127,0,0,1)",originX:"center",originY:"center",globalCompositeOperation:"destination-in",left:this.image.left,top:this.image.top}),this.canvas.add(this.viewport),this.renderImage()},_createFocalPoint:function(){var a=this.getScaledImageDimensions().width/this.focalPointState.imageDimensions.width,b=this.focalPointState.offsetX*a*this.zoomRatio,c=this.focalPointState.offsetY*a*this.zoomRatio;if(b+=this.image.left,c+=this.image.top,"crop"!=this.currentView&&this.viewport&&!this._isCenterInside(this.image,this.viewport)){var d=this.viewport.left-this.image.left,e=this.viewport.top-this.image.top;b+=d,c+=e,this.focalPointState.offsetX+=d,this.focalPointState.offsetY+=e}this.focalPoint=new fabric.Group([new fabric.Circle({radius:1,fill:"rgba(255,255,255,0)",strokeWidth:2,stroke:"rgba(255,255,255,0.8)",left:0,top:0,originX:"center",originY:"center"}),new fabric.Circle({radius:8,fill:"rgba(255,255,255,0)",strokeWidth:2,stroke:"rgba(255,255,255,0.8)",left:0,top:0,originX:"center",originY:"center"})],{originX:"center",originY:"center",left:b,top:c}),this.canvas.add(this.focalPoint)},toggleFocalPoint:function(){this.focalPoint?(this.canvas.remove(this.focalPoint),this.focalPoint=null):this._createFocalPoint(),this.renderImage()},_repositionViewport:function(){if(this.viewport){var a={left:this.editorWidth/2,top:this.editorHeight/2};if("crop"==this.currentView)a.width=this.editorWidth,a.height=this.editorHeight;else if(this.cropperState){var b=this.cropperState,c=this.getScaledImageDimensions(),d=c.width/b.imageDimensions.width;a.width=b.width*d*this.zoomRatio,a.height=b.height*d*this.zoomRatio,this.image.set({left:this.editorWidth/2-b.offsetX*d,top:this.editorHeight/2-b.offsetY*d})}else $.extend(a,this.getScaledImageDimensions());this.viewport.set(a)}},_repositionFocalPoint:function(a){if(this.focalPoint){var b=this.focalPoint.left-this.editorWidth/2,c=this.focalPoint.top-this.editorHeight/2,d=this.image.width,e=this.getScaledImageDimensions().width*this.zoomRatio,f=e/d;b-=(a.width-this.editorWidth)/2,c-=(a.height-this.editorHeight)/2,b*=f,c*=f,this.focalPoint.set({left:this.editorWidth/2+b,top:this.editorHeight/2+c})}},hasOrientationChanged:function(){return this.viewportRotation%180!=0},getScaledImageDimensions:function(){var a=this.originalHeight/this.originalWidth,b=this.editorHeight/this.editorWidth,c={};return a>b?(c.height=Math.min(this.editorHeight,this.originalHeight),c.width=Math.round(this.originalWidth/(this.originalHeight/c.height))):(c.width=Math.min(this.editorWidth,this.originalWidth),c.height=Math.round(this.originalHeight*(c.width/this.originalWidth))),c},_zoomImage:function(){var a=this.getScaledImageDimensions();this.image.set({width:a.width*this.zoomRatio,height:a.height*this.zoomRatio})},_addControlListeners:function(){this.addListener(this.$tabs,"click","_handleTabClick"),this.addListener($(".focal-point"),"click",function(a){this.toggleFocalPoint(a)}.bind(this)),this.addListener($(".rotate-left"),"click",function(){this.rotateImage(-90)}.bind(this)),this.addListener($(".rotate-right"),"click",function(){this.rotateImage(90)}.bind(this)),this.addListener($(".flip-vertical"),"click",function(){this.flipImage("y")}.bind(this)),this.addListener($(".flip-horizontal"),"click",function(){this.flipImage("x")}.bind(this)),this.straighteningInput=new SlideRuleInput("slide-rule",{onStart:function(){this._showGrid()}.bind(this),onChange:function(a){this.straighten(a)}.bind(this),onEnd:function(){this._hideGrid(),this._cleanupFocalPointAfterStraighten()}.bind(this)}),this.addListener(Garnish.$doc,"keydown",function(a){a.keyCode==Garnish.SHIFT_KEY&&(this.shiftKeyHeld=!0)}.bind(this)),this.addListener(Garnish.$doc,"keyup",function(a){a.keyCode==Garnish.SHIFT_KEY&&(this.shiftKeyHeld=!1)}.bind(this))},_handleTabClick:function(a){if(!this.animationInProgress){var b=$(a.currentTarget),c=b.data("view");this.$tabs.removeClass("selected"),b.addClass("selected"),this.showView(c)}},showView:function(a){this.$views.addClass("hidden");var b=this.$views.filter('[data-view="'+a+'"]');b.removeClass("hidden"),"rotate"==a?this.enableSlider():this.disableSlider(),this.updateSizeAndPosition(),"crop"==this.currentView&&"crop"!=a?this.disableCropMode():"crop"!=this.currentView&&"crop"==a&&this.enableCropMode(),this.currentView=a},storeCropperState:function(a){if(a)this.cropperState=a;else if(this.clipper){var b=1/this.zoomRatio;this.cropperState={offsetX:(this.clipper.left-this.image.left)*b,offsetY:(this.clipper.top-this.image.top)*b,height:this.clipper.height*b,width:this.clipper.width*b,imageDimensions:this.getScaledImageDimensions()}}else{var c=this.getScaledImageDimensions();this.cropperState={offsetX:0,offsetY:0,height:c.height,width:c.width,imageDimensions:c}}},storeFocalPointState:function(a){if(a)this.focalPointState=a;else if(this.focalPoint){var b=1/this.zoomRatio;this.focalPointState={offsetX:(this.focalPoint.left-this.image.left)*b,offsetY:(this.focalPoint.top-this.image.top)*b,imageDimensions:this.getScaledImageDimensions()}}},rotateImage:function(a){if(!this.animationInProgress){if(90!=a&&a!=-90)return!1;this.animationInProgress=!0,this.viewportRotation+=a,this.viewportRotation=parseInt((this.viewportRotation+360)%360,10);var b,c=this.image.angle+a,d=this.getScaledImageDimensions();b=this.hasOrientationChanged()?this.getZoomToCoverRatio({height:d.width,width:d.height}):this.getZoomToCoverRatio(d),this.zoomRatio>b&&(b=this.zoomRatio);var e={angle:90==a?"+=90":"-=90"},f={angle:c,width:d.width*b,height:d.height*b},g=1;this.scaleFactor<1?(g=1/this.scaleFactor,this.scaleFactor=1):(this.viewport.width>this.editorHeight?g=this.editorHeight/this.viewport.width:this.viewport.height>this.editorWidth&&(g=this.editorWidth/this.viewport.height),this.scaleFactor=g),g<1&&(f.width*=g,f.height*=g);var h=this.cropperState,i=h.offsetX,j=h.offsetY,k=a*(Math.PI/180),l=i*Math.cos(k)-j*Math.sin(k),m=i*Math.sin(k)+j*Math.cos(k),n=d.width/h.imageDimensions.width,o=l*n*this.zoomRatio*this.scaleFactor,p=m*n*this.zoomRatio*this.scaleFactor;f.left=this.editorWidth/2-o,f.top=this.editorHeight/2-p,h.offsetX=l,h.offsetY=m;var q=h.width;h.width=h.height,h.height=q,this.storeCropperState(h),this.focalPoint&&this.canvas.remove(this.focalPoint),this.viewport.animate(e,{duration:this.settings.animationDuration,onComplete:function(){var a=this.viewport.height*g;this.viewport.height=this.viewport.width*g,this.viewport.width=a,this.viewport.set({angle:0})}.bind(this)}),this.image.animate(f,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){var b=parseFloat((this.image.angle+360)%360);this.image.set({angle:b}),this.animationInProgress=!1,this.focalPoint&&(this._adjustFocalPointByAngle(a),this.straighten(this.straighteningInput),this.canvas.add(this.focalPoint))}.bind(this)})}},flipImage:function(a){if(!this.animationInProgress){this.animationInProgress=!0,this.hasOrientationChanged()&&(a="y"==a?"x":"y"),this.focalPoint&&this.canvas.remove(this.focalPoint);var b={x:this.editorWidth/2,y:this.editorHeight/2};this.straighteningInput.setValue(-this.imageStraightenAngle),this.imageStraightenAngle=-this.imageStraightenAngle;var c,d,e={angle:this.viewportRotation+this.imageStraightenAngle},f=this.cropperState;"y"==a?(e.scaleY=this.image.scaleY*-1,this.flipData.y=1-this.flipData.y,this.hasOrientationChanged()?(d=this.image.left-b.x,e.left=b.x-d,f&&(f.offsetX=-f.offsetX),this.focalPointState.offsetX=-this.focalPointState.offsetX):(c=this.image.top-b.y,e.top=b.y-c,f&&(f.offsetY=-f.offsetY),this.focalPointState.offsetY=-this.focalPointState.offsetY)):(e.scaleX=this.image.scaleX*-1,this.flipData.x=1-this.flipData.x,this.hasOrientationChanged()?(c=this.image.top-b.y,e.top=b.y-c,f&&(f.offsetY=-f.offsetY),this.focalPointState.offsetY=-this.focalPointState.offsetY):(d=this.image.left-b.x,e.left=b.x-d,f&&(f.offsetX=-f.offsetX),this.focalPointState.offsetX=-this.focalPointState.offsetX)),f&&this.storeCropperState(f),this.image.animate(e,{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){this.animationInProgress=!1,this.focalPoint&&(this._adjustFocalPointByAngle(0),this.canvas.add(this.focalPoint))}.bind(this)})}},straighten:function(a){if(!this.animationInProgress){this.animationInProgress=!0;var b=this.image.angle;this.imageStraightenAngle=parseFloat(a.value)%360,this.image.set({angle:this.viewportRotation+this.imageStraightenAngle}),this.zoomRatio=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor,this._zoomImage(),this.cropperState&&this._adjustEditorElementsOnStraighten(b),this.renderImage(),this.animationInProgress=!1}},_adjustEditorElementsOnStraighten:function(a){var b,c,d,e,f,g=this.getScaledImageDimensions(),h=this.image.angle-a,i=this.cropperState,j=this.zoomRatio,k=1;do{var l=i.offsetX,m=i.offsetY,n=h*(Math.PI/180);d=l*Math.cos(n)-m*Math.sin(n),e=l*Math.sin(n)+m*Math.cos(n),f=g.width/i.imageDimensions.width,b=d*j*f,c=e*j*f;var o=this.getImageVerticeCoords(j),p={width:this.viewport.width,height:this.viewport.height,left:this.editorWidth/2-this.viewport.width/2+b,top:this.editorHeight/2-this.viewport.height/2+c};k=this._getZoomRatioToFitRectangle(p,o),j*=k}while(1!=k);this.image.set({left:this.editorWidth/2-b,top:this.editorHeight/2-c}),i.offsetX=d,i.offsetY=e,i.width=this.viewport.width/j/f,i.height=this.viewport.height/j/f,this.storeCropperState(i),this.zoomRatio=j,this.focalPoint&&(this._adjustFocalPointByAngle(h),this._isCenterInside(this.focalPoint,this.viewport)?this.focalPoint.set({opacity:1}):this.focalPoint.set({opacity:0})),this._zoomImage()},_cleanupFocalPointAfterStraighten:function(){if(this.focalPoint&&!this._isCenterInside(this.focalPoint,this.viewport)){this.focalPoint.set({opacity:1});var a=this.focalPointState;a.offsetX=0,a.offsetY=0,this.storeFocalPointState(a),this.toggleFocalPoint()}},_isCenterInside:function(a,b){return a.left>b.left-b.width/2&&a.top>b.top-b.height/2&&a.left<b.left+b.width/2&&a.top<b.top+b.height/2},_adjustFocalPointByAngle:function(a){var b=a*(Math.PI/180),c=this.focalPointState,d=c.offsetX,e=c.offsetY,f=d*Math.cos(b)-e*Math.sin(b),g=d*Math.sin(b)+e*Math.cos(b),h=this.getScaledImageDimensions().width/c.imageDimensions.width,i=f*h*this.zoomRatio,j=g*h*this.zoomRatio;this.focalPoint.left=this.image.left+i,this.focalPoint.top=this.image.top+j,c.offsetX=f,c.offsetY=g,this.storeFocalPointState(c)},_getZoomRatioToFitRectangle:function(a,b){for(var c,d=this._getRectangleVertices(a),e=0;e<d.length&&(c=d[e],this.arePointsInsideRectangle([c],b));e++)c=!1;var f;if(c){var g=this._getEdgeCrossed(b,c),h={x:a.left+a.width/2,y:a.top+a.height/2},i=Math.abs((g[1].y-g[0].y)*c.x-(g[1].x-g[0].x)*c.y+g[1].x*g[0].y-g[1].y*g[0].x)/Math.sqrt(Math.pow(g[1].y-g[0].y,2)+Math.pow(g[1].x-g[0].x,2)),j=Math.abs((g[1].y-g[0].y)*h.x-(g[1].x-g[0].x)*h.y+g[1].x*g[0].y-g[1].y*g[0].x)/Math.sqrt(Math.pow(g[1].y-g[0].y,2)+Math.pow(g[1].x-g[0].x,2));f=(i+j)/j}else f=1;return f},saveImage:function(a){var b=$(a.currentTarget);if(b.hasClass("disabled"))return!1;$(".btn",this.$buttons).addClass("disabled"),this.$buttons.append('<div class="spinner"></div>');var c={assetId:this.assetId,viewportRotation:this.viewportRotation,imageRotation:this.imageStraightenAngle,replace:b.hasClass("replace")?1:0};if(this.cropperState){var d={};d.height=this.cropperState.height,d.width=this.cropperState.width,d.offsetX=this.cropperState.offsetX,d.offsetY=this.cropperState.offsetY,c.imageDimensions=this.cropperState.imageDimensions,c.cropData=d}else c.imageDimensions=this.getScaledImageDimensions();this.focalPoint&&(c.focalPoint=this.focalPointState),c.flipData=this.flipData,c.zoom=this.zoomRatio,Craft.postActionRequest("assets/save-image",c,function(){this.$buttons.find(".btn").removeClass("disabled").end().find(".spinner").remove(),this.onSave(),this.hide()}.bind(this))},getZoomToCoverRatio:function(a){var b=Math.abs(this.imageStraightenAngle)*(Math.PI/180),c=Math.sin(b)*a.height+Math.cos(b)*a.width,d=Math.sin(b)*a.width+Math.cos(b)*a.height;return Math.max(c/a.width,d/a.height)},getZoomToFitRatio:function(a){var b=this._getImageBoundingBox(a),c=1;if(b.height>this.editorHeight||b.width>this.editorWidth){var d=this.editorHeight/b.height,e=this.editorWidth/b.width;c=Math.min(e,d)}return c},getCombinedZoomRatio:function(a){return this.getZoomToCoverRatio(a)/this.getZoomToFitRatio(a)},_showGrid:function(){if(!this.grid){var a,b={strokeWidth:1,stroke:"rgba(255,255,255,0.5)"},c=8,d=this.viewport.width,e=this.viewport.height,f=d/(c+1),g=e/(c+1),h=[new fabric.Rect({strokeWidth:2,stroke:"rgba(255,255,255,1)",originX:"center",originY:"center",width:d,height:e,left:d/2,top:e/2,fill:"rgba(255,255,255,0)"})];for(a=1;a<=c;a++)h.push(new fabric.Line([a*f,0,a*f,e],b));for(a=1;a<=c;a++)h.push(new fabric.Line([0,a*g,d,a*g],b));this.grid=new fabric.Group(h,{left:this.editorWidth/2,top:this.editorHeight/2,originX:"center",originY:"center",angle:this.viewport.angle}),this.canvas.add(this.grid),this.renderImage()}},_hideGrid:function(){this.canvas.remove(this.grid),this.grid=null,this.renderImage()},onFadeOut:function(){this.removeListener(this.$croppingCanvas,"mousemove",this._handleMouseMove.bind(this)),this.removeListener(this.$croppingCanvas,"mousedown",this._handleMouseDown.bind(this)),this.removeListener(this.$croppingCanvas,"mouseup",this._handleMouseUp.bind(this)),this.removeListener(this.$croppingCanvas,"mouseout",function(a){this._handleMouseUp(a),this._handleMouseMove(a)}.bind(this)),this.destroy()},show:function(){this.base(),$("html").addClass("noscroll")},hide:function(){this.removeAllListeners(),this.straighteningInput.removeAllListeners(),$("html").removeClass("noscroll"),this.base()},onSave:function(){this.settings.onSave()},enableSlider:function(){this.$imageTools.removeClass("hidden")},disableSlider:function(){this.$imageTools.addClass("hidden")},enableCropMode:function(){this._setEditorMode("crop")},disableCropMode:function(){this._setEditorMode("regular")},_setEditorMode:function(a){if(!this.animationInProgress){this.animationInProgress=!0;var b=this.getScaledImageDimensions(),c=$.extend({},b),d={left:this.editorWidth/2,top:this.editorHeight/2},e=$.noop;if(this.focalPoint&&(this.canvas.remove(this.focalPoint),this.renderImage()),"crop"==a)this.zoomRatio=this.getZoomToFitRatio(b),c={width:this.editorWidth,height:this.editorHeight},e=function(){this._setFittedImageVerticeCoordinates();var a=this.cropperState,b=this.getScaledImageDimensions(),c=b.width/a.imageDimensions.width,d={left:this.image.left+a.offsetX*c*this.zoomRatio,top:this.image.top+a.offsetY*c*this.zoomRatio,width:a.width*c*this.zoomRatio,height:a.height*c*this.zoomRatio};this._showCropper(d),this.focalPoint&&(c=b.width/this.focalPointState.imageDimensions.width,this.focalPoint.left=this.image.left+this.focalPointState.offsetX*c*this.zoomRatio,this.focalPoint.top=this.image.top+this.focalPointState.offsetY*c*this.zoomRatio,this.canvas.add(this.focalPoint))}.bind(this);else{this._hideCropper();var f=this.getZoomToCoverRatio(this.getScaledImageDimensions())*this.scaleFactor,g=f/this.zoomRatio;this.zoomRatio=f;var h=this.clipper.left-this.image.left,i=this.clipper.top-this.image.top,j=h*g,k=i*g;if(d.left=this.editorWidth/2-j,d.top=this.editorHeight/2-k,c.height=this.clipper.height*g,c.width=this.clipper.width*g,this.focalPoint&&!this._isCenterInside(this.focalPoint,this.clipper)){this.focalPoint.set({opacity:1});var l=this.focalPointState;l.offsetX=0,l.offsetY=0,this.storeFocalPointState(l),this.toggleFocalPoint()}e=function(){if(this.focalPoint){var a=this.getScaledImageDimensions().width/this.focalPointState.imageDimensions.width;this.focalPoint.left=this.image.left+this.focalPointState.offsetX*a*this.zoomRatio,this.focalPoint.top=this.image.top+this.focalPointState.offsetY*a*this.zoomRatio,this.canvas.add(this.focalPoint)}}.bind(this)}this.image.animate({width:b.width*this.zoomRatio,height:b.height*this.zoomRatio,left:d.left,top:d.top},{onChange:this.canvas.renderAll.bind(this.canvas),duration:this.settings.animationDuration,onComplete:function(){e(),this.animationInProgress=!1,this.renderImage()}.bind(this)}),this.viewport.animate({width:c.width,height:c.height},{duration:this.settings.animationDuration})}},_showCropper:function(a){this._setupCropperLayer(a),this._redrawCropperElements(),this.renderCropper()},_hideCropper:function(){this.clipper&&(this.croppingCanvas.remove(this.clipper),this.croppingCanvas.remove(this.croppingShade),this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.cropperGrid),this.croppingCanvas.remove(this.croppingRectangle),this.croppingCanvas=null,this.renderCropper=null)},_setupCropperLayer:function(a){this.croppingCanvas=new fabric.StaticCanvas("cropping-canvas",{backgroundColor:"rgba(0,0,0,0)",hoverCursor:"default",selection:!1}),this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight}),this.renderCropper=function(){Garnish.requestAnimationFrame(this.croppingCanvas.renderAll.bind(this.croppingCanvas))}.bind(this),$("#cropping-canvas",this.$editorContainer).css({position:"absolute",top:0,left:0}),this.croppingShade=new fabric.Rect({left:this.editorWidth/2,top:this.editorHeight/2,originX:"center",originY:"center",width:this.editorWidth,height:this.editorHeight,fill:"rgba(0,0,0,0.7)"});var b=this.getScaledImageDimensions(),c=0==this.imageStraightenAngle?1:1.2*this.getCombinedZoomRatio(b),d=b.width/c,e=b.height/c;if(this.hasOrientationChanged()){var f=e;e=d,d=f}this.clipper=new fabric.Rect({left:this.editorWidth/2,top:this.editorHeight/2,originX:"center",originY:"center",width:d,height:e,stroke:"black",fill:"rgba(128,0,0,1)",strokeWidth:0}),a&&this.clipper.set(a),this.clipper.globalCompositeOperation="destination-out",this.croppingCanvas.add(this.croppingShade),this.croppingCanvas.add(this.clipper)},_redrawCropperElements:function(){this.cropperHandles&&(this.croppingCanvas.remove(this.cropperHandles),this.croppingCanvas.remove(this.cropperGrid),this.croppingCanvas.remove(this.croppingRectangle));var a={strokeWidth:4,stroke:"rgb(255,255,255)",fill:!1},b={strokeWidth:2,stroke:"rgba(255,255,255,0.5)"},c=[new fabric.Path("M 0,10 L 0,0 L 10,0",a),new fabric.Path("M "+(this.clipper.width-8)+",0 L "+(this.clipper.width+4)+",0 L "+(this.clipper.width+4)+",10",a),new fabric.Path("M "+(this.clipper.width+4)+","+(this.clipper.height-8)+" L"+(this.clipper.width+4)+","+(this.clipper.height+4)+" L "+(this.clipper.width-8)+","+(this.clipper.height+4),a),new fabric.Path("M 10,"+(this.clipper.height+4)+" L 0,"+(this.clipper.height+4)+" L 0,"+(this.clipper.height-8),a)];this.cropperHandles=new fabric.Group(c,{left:this.clipper.left,top:this.clipper.top,originX:"center",originY:"center"}),this.croppingRectangle=new fabric.Rect({left:this.clipper.left,top:this.clipper.top,width:this.clipper.width,height:this.clipper.height,fill:"rgba(0,0,0,0)",stroke:"rgba(255,255,255,0.8)",strokeWidth:2,originX:"center",originY:"center"}),this.cropperGrid=new fabric.Group([new fabric.Line([.33*this.clipper.width,0,.33*this.clipper.width,this.clipper.height],b),new fabric.Line([.66*this.clipper.width,0,.66*this.clipper.width,this.clipper.height],b),new fabric.Line([0,.33*this.clipper.height,this.clipper.width,.33*this.clipper.height],b),new fabric.Line([0,.66*this.clipper.height,this.clipper.width,.66*this.clipper.height],b)],{left:this.clipper.left,top:this.clipper.top,originX:"center",originY:"center"}),this.croppingCanvas.add(this.cropperHandles),this.croppingCanvas.add(this.cropperGrid),this.croppingCanvas.add(this.croppingRectangle)},_repositionCropper:function(a){if(this.croppingCanvas){var b={x:this.clipper.left-this.croppingCanvas.width/2,y:this.clipper.top-this.croppingCanvas.height/2};this.croppingCanvas.setDimensions({width:this.editorWidth,height:this.editorHeight});var c=this._getBoundingRectangle(this.imageVerticeCoords),d=c.width/a.width;this.clipper.width=Math.round(this.clipper.width*d),this.clipper.height=Math.round(this.clipper.height*d),this.clipper.left=this.editorWidth/2+b.x*d,this.clipper.top=this.editorHeight/2+b.y*d,this.croppingShade.set({width:this.editorWidth,height:this.editorHeight,left:this.editorWidth/2,top:this.editorHeight/2}),this._redrawCropperElements(),this.renderCropper()}},_getBoundingRectangle:function(a){return{width:Math.max(a.a.x,a.b.x,a.c.x,a.d.x)-Math.min(a.a.x,a.b.x,a.c.x,a.d.x),height:Math.max(a.a.y,a.b.y,a.c.y,a.d.y)-Math.min(a.a.y,a.b.y,a.c.y,a.d.y)}},_handleMouseDown:function(a){var b=this.focalPoint&&this._isMouseOver(a,this.focalPoint),c=this.croppingCanvas&&this._isMouseOver(a,this.clipper),d=this.croppingCanvas&&this._cropperHandleHitTest(a);(d||c||b)&&(this.previousMouseX=a.pageX,this.previousMouseY=a.pageY,b?this.draggingFocal=!0:d?this.scalingCropper=d:c&&(this.draggingCropper=!0))},_handleMouseMove:function(a){this.focalPoint&&this.draggingFocal?(this._handleFocalDrag(a),this.storeFocalPointState(),this.renderImage()):this.draggingCropper||this.scalingCropper?(this.draggingCropper?this._handleCropperDrag(a):this._handleCropperResize(a),this._redrawCropperElements(),this.storeCropperState(),this.renderCropper()):this._setMouseCursor(a),this.previousMouseX=a.pageX,this.previousMouseY=a.pageY},_handleMouseUp:function(){this.draggingCropper=!1,this.scalingCropper=!1,this.draggingFocal=!1},_handleCropperDrag:function(a){var b=a.pageX-this.previousMouseX,c=a.pageY-this.previousMouseY;if(0!=b||0!=c){var d={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height},e=this._getRectangleVertices(d,b,c);this.arePointsInsideRectangle(e,this.imageVerticeCoords)&&this.clipper.set({left:this.clipper.left+b,top:this.clipper.top+c})}},_handleFocalDrag:function(a){if(this.focalPoint){var b=a.pageX-this.previousMouseX,c=a.pageY-this.previousMouseY;if(0==b&&0==c)return;var d=this.focalPoint.left+b,e=this.focalPoint.top+c;if("crop"==this.currentView){if(!this.arePointsInsideRectangle([{x:d,y:e}],this.imageVerticeCoords))return}else if(!(this.viewport.left-this.viewport.width/2-d<0&&this.viewport.left+this.viewport.width/2-d>0&&this.viewport.top-this.viewport.height/2-e<0&&this.viewport.top+this.viewport.height/2-e>0))return;this.focalPoint.set({left:this.focalPoint.left+b,top:this.focalPoint.top+c})}},_handleCropperResize:function(a){var b=a.pageX-this.previousMouseX,c=a.pageY-this.previousMouseY;if(0!=b||0!=c){if(this.shiftKeyHeld&&("tl"==this.scalingCropper||"tr"==this.scalingCropper||"bl"==this.scalingCropper||"br"==this.scalingCropper)){var d;Math.abs(b)>Math.abs(c)?(d=this.clipper.width/this.clipper.height,c=b/d,c*="tr"==this.scalingCropper||"bl"==this.scalingCropper?-1:1):(d=this.clipper.width/this.clipper.height,b=c*d,b*="tr"==this.scalingCropper||"bl"==this.scalingCropper?-1:1)}var e={left:this.clipper.left-this.clipper.width/2,top:this.clipper.top-this.clipper.height/2,width:this.clipper.width,height:this.clipper.height};switch(this.scalingCropper){case"t":e.top+=c,e.height-=c;break;case"b":e.height+=c;break;case"l":e.left+=b,e.width-=b;break;case"r":e.width+=b;break;case"tl":e.top+=c,e.height-=c,e.left+=b,e.width-=b;break;case"tr":e.top+=c,e.height-=c,e.width+=b;break;case"bl":e.height+=c,e.left+=b,e.width-=b;break;case"br":e.height+=c,e.width+=b}if(!(e.height<30||e.width<30)){var f=this._getRectangleVertices(e);this.arePointsInsideRectangle(f,this.imageVerticeCoords)&&(this.clipper.set({top:e.top+e.height/2,left:e.left+e.width/2,width:e.width,height:e.height}),this._redrawCropperElements())}}},_setMouseCursor:function(a){var b="default",c=this.croppingCanvas&&this._cropperHandleHitTest(a);this.focalPoint&&this._isMouseOver(a,this.focalPoint)?b="pointer":c?"t"==c||"b"==c?b="ns-resize":"l"==c||"r"==c?b="ew-resize":"tl"==c||"br"==c?b="nwse-resize":"bl"!=c&&"tr"!=c||(b="nesw-resize"):this.croppingCanvas&&this._isMouseOver(a,this.clipper)&&(b="move"),$(".body").css("cursor",b)},_cropperHandleHitTest:function(a){var b=this.$croppingCanvas.offset(),c=a.pageX-b.left,d=a.pageY-b.top,e=this.clipper.left-this.clipper.width/2,f=e+this.clipper.width,g=this.clipper.top-this.clipper.height/2,h=g+this.clipper.height;if(c<e+10&&c>e-3){if(d<g+10&&d>g-3)return"tl";if(d<h+3&&d>h-10)return"bl"}if(c>f-13&&c<f+3){if(d<g+10&&d>g-3)return"tr";if(d<h+2&&d>h-10)return"br"}return c<e+3&&c>e-3&&d<h-10&&d>g+10?"l":c<f+1&&c>f-5&&d<h-10&&d>g+10?"r":d<g+4&&d>g-2&&c>e+10&&c<f-10?"t":d<h+2&&d>h-4&&c>e+10&&c<f-10&&"b"},_isMouseOver:function(a,b){var c=this.$croppingCanvas.offset(),d=a.pageX-c.left,e=a.pageY-c.top,f=b.left-b.width/2,g=f+b.width,h=b.top-b.height/2,i=h+b.height;return d>=f&&d<=g&&e>=h&&e<=i},_getRectangleVertices:function(a,b,c){"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=0);var d={x:a.left+b,y:a.top+c},e={x:d.x+a.width,y:d.y},f={x:e.x,y:e.y+a.height},g={x:d.x,y:f.y};return[d,e,f,g]},_setFittedImageVerticeCoordinates:function(){this.imageVerticeCoords=this.getImageVerticeCoords("fit")},getImageVerticeCoords:function(a){var b,c=-1*((this.hasOrientationChanged()?90:0)+this.imageStraightenAngle)*(Math.PI/180),d=this.getScaledImageDimensions();b="number"==typeof a?a:"cover"==a?this.getZoomToCoverRatio(d):this.getZoomToFitRatio(d);var e=d.height*b,f=d.width*b,g=Math.cos(c)*e,h=Math.sin(c)*f,i=Math.cos(c)*f,j=Math.sin(c)*e,k=(this.editorHeight-(g+h))/2,l=(this.editorWidth-(j+i))/2;return{a:{x:l+i,y:k},b:{x:this.editorWidth-l,y:k+g},c:{x:l+j,y:this.editorHeight-k},d:{x:l,y:k+h}}},_debug:function(a){this.canvas.remove(this.debugger),this.debugger=a,this.canvas.add(this.debugger)},arePointsInsideRectangle:function(a,b){for(var c=this._getVector(b.a,b.b),d=this._getVector(b.b,b.c),e=this._getScalarProduct(c,c),f=this._getScalarProduct(d,d),g=0;g<a.length;g++){var h=a[g],i=this._getVector(b.a,h),j=this._getVector(b.b,h),k=this._getScalarProduct(c,i),l=this._getScalarProduct(d,j),m=0<=k&&k<=e,n=0<=l&&l<=f;if(!m||!n)return!1}return!0},_getVector:function(a,b){return{x:b.x-a.x,y:b.y-a.y}},_getScalarProduct:function(a,b){return a.x*b.x+a.y*b.y},_getVectorMagnitude:function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},_getAngleBetweenVectors:function(a,b){return Math.round(180*Math.acos(Math.min(1,this._getScalarProduct(a,b)/(this._getVectorMagnitude(a)*this._getVectorMagnitude(b))))/Math.PI*100)/100},_getEdgeCrossed:function(a,b){for(var c=[[a.a,a.b],[a.b,a.c],[a.c,a.d],[a.d,a.a]],d={
x:this.editorWidth/2,y:this.editorHeight/2},e=180,f=null,g=0;g<c.length;g++){var h=c[g],i=this._getVector(h[0],d),j=this._getVector(h[0],h[1]),k=this._getVector(h[0],b),l=Math.abs(this._getAngleBetweenVectors(i,k)-(this._getAngleBetweenVectors(i,j)+this._getAngleBetweenVectors(j,k)));l<e&&(e=l,f=h)}return f},_getImageBoundingBox:function(a){var b={},c=Math.abs(this.imageStraightenAngle)*(Math.PI/180),d=a.height/a.width;if(b.height=a.width*(Math.sin(c)+Math.cos(c)*d),b.width=a.width*(Math.cos(c)+Math.sin(c)*d),this.hasOrientationChanged()){var e=b.width;b.width=b.height,b.height=e}return b}},{defaults:{animationDuration:100,allowSavingAsNew:!0,onSave:$.noop}});
//# sourceMappingURL=AssetImageEditor.min.js.map